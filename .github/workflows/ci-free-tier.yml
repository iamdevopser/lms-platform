name: CI Pipeline (Free Tier Optimized)

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: lms-platform-free
  ECS_SERVICE: lms-platform-free-service
  ECS_CLUSTER: lms-platform-free-cluster
  ECS_TASK_DEFINITION: aws/task-definition.json
  CONTAINER_NAME: lms-app

jobs:
  # Code Quality Checks
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, redis, zip, gd, curl, xml, soap, intl, bcmath, pcntl
        coverage: xdebug

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Install NPM dependencies
      run: npm ci --cache .npm --prefer-offline

    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    - name: Generate key
      run: php artisan key:generate

    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: PHP Code Quality (PHPStan)
      run: |
        composer require --dev phpstan/phpstan --no-interaction
        ./vendor/bin/phpstan analyse --memory-limit=128M --no-progress

    - name: PHP Code Style (Laravel Pint)
      run: |
        composer require --dev laravel/pint --no-interaction
        ./vendor/bin/pint --test

    - name: JavaScript Code Quality (ESLint)
      run: npm run lint

    - name: Security Check (Composer Audit)
      run: composer audit --locked

    - name: Security Check (NPM Audit)
      run: npm audit --audit-level moderate

  # Unit and Feature Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Free Tier optimization
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: lms_platform_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, redis, zip, gd, curl, xml, soap, intl, bcmath, pcntl
        coverage: xdebug

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Install NPM dependencies
      run: npm ci --cache .npm --prefer-offline

    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    - name: Generate key
      run: php artisan key:generate

    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Create Database
      run: |
        mysql --host 127.0.0.1 --port 3306 -uroot -ppassword -e "CREATE DATABASE IF NOT EXISTS lms_platform_test;"

    - name: Run Database Migrations
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: lms_platform_test
        DB_USERNAME: root
        DB_PASSWORD: password
        REDIS_HOST: 127.0.0.1
        REDIS_PORT: 6379
      run: php artisan migrate --force

    - name: Execute PHP Tests
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: lms_platform_test
        DB_USERNAME: root
        DB_PASSWORD: password
        REDIS_HOST: 127.0.0.1
        REDIS_PORT: 6379
      run: php artisan test --coverage --min=80

    - name: Execute JavaScript Tests
      run: npm test

    - name: Build frontend assets
      run: npm run build

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          storage/logs/
          tests/results/

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: php, javascript

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # Docker Build and Push (Only on main branch)
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [code-quality, test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20  # Free Tier optimization
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build optimized Docker image for Free Tier
        docker build -f Dockerfile.free-tier -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Push images
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - name: Update ECS task definition
      run: |
        # Download current task definition
        aws ecs describe-task-definition --task-definition $ECS_TASK_DEFINITION --query taskDefinition > task-definition.json
        
        # Update image URI
        jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '.containerDefinitions[0].image = $IMAGE' task-definition.json > updated-task-definition.json
        
        # Register new task definition
        aws ecs register-task-definition --cli-input-json file://updated-task-definition.json

    - name: Deploy to ECS (Staging)
      run: |
        # Update ECS service with new task definition
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [code-quality, test, security-scan, build-and-push]
    if: always()
    
    steps:
    - name: Notify Success
      if: ${{ needs.build-and-push.result == 'success' }}
      run: |
        echo "âœ… CI Pipeline completed successfully!"
        echo "ğŸš€ Application deployed to staging environment"
        echo "ğŸ“Š Test coverage: $(cat test-results/coverage.txt 2>/dev/null || echo 'N/A')"
        echo "ğŸ”’ Security scan: Passed"
        echo "ğŸ³ Docker image: Built and pushed to ECR"

    - name: Notify Failure
      if: ${{ needs.build-and-push.result == 'failure' }}
      run: |
        echo "âŒ CI Pipeline failed!"
        echo "ğŸ” Check the logs for details"
        echo "ğŸ“§ Notify team members if needed"





