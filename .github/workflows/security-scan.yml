name: Security Scanning (Free Tier)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  # CodeQL Analysis
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'php', 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

  # Dependency Scanning
  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, redis, zip, gd, curl, xml, soap, intl, bcmath, pcntl

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Install NPM dependencies
      run: npm ci --cache .npm --prefer-offline

    - name: Run Composer Audit
      run: composer audit --locked --format=json > composer-audit.json

    - name: Run NPM Audit
      run: npm audit --audit-level moderate --json > npm-audit.json

    - name: Upload audit results
      uses: actions/upload-artifact@v3
      with:
        name: dependency-audit-results
        path: |
          composer-audit.json
          npm-audit.json

  # Container Security Scanning
  container-scan:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -f Dockerfile.free-tier -t lms-platform:security-scan .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'lms-platform:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # SAST (Static Application Security Testing)
  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, redis, zip, gd, curl, xml, soap, intl, bcmath, pcntl

    - name: Install PHPStan
      run: composer require --dev phpstan/phpstan --no-interaction

    - name: Run PHPStan Security Rules
      run: |
        ./vendor/bin/phpstan analyse \
          --memory-limit=128M \
          --no-progress \
          --level=8 \
          --configuration=phpstan-security.neon

    - name: Install Psalm
      run: composer require --dev vimeo/psalm --no-interaction

    - name: Run Psalm Security Analysis
      run: |
        ./vendor/bin/psalm \
          --config=psalm-security.xml \
          --threads=2

  # Infrastructure Security Scanning
  infrastructure-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Checkov
      run: pip install checkov

    - name: Run Checkov on CloudFormation templates
      run: |
        checkov -f aws/infrastructure.yml --output sarif --output-file-path checkov-results.sarif

    - name: Upload Checkov results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'checkov-results.sarif'

  # Security Headers Test
  security-headers:
    name: Security Headers Test
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, redis, zip, gd, curl, xml, soap, intl, bcmath, pcntl

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Start Laravel server
      run: php artisan serve --host=0.0.0.0 --port=8000 &
      env:
        APP_ENV: testing
        APP_KEY: base64:test-key-for-testing
        DB_CONNECTION: sqlite
        DB_DATABASE: :memory:

    - name: Wait for server
      run: sleep 10

    - name: Test security headers
      run: |
        curl -I http://localhost:8000 | grep -i "x-frame-options\|x-xss-protection\|x-content-type-options\|strict-transport-security"

  # Secrets Scanning
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # License Compliance
  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Free Tier optimization
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --cache .npm --prefer-offline

    - name: Run License Checker
      run: |
        npm install -g license-checker
        license-checker --json > license-report.json

    - name: Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-compliance-report
        path: license-report.json

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, container-scan, sast-scan, infrastructure-scan, security-headers, secrets-scan, license-scan]
    if: always()
    
    steps:
    - name: Security Scan Summary
      run: |
        echo "ðŸ”’ Security Scan Summary"
        echo "========================"
        echo "CodeQL Analysis: ${{ needs.codeql-analysis.result }}"
        echo "Dependency Scan: ${{ needs.dependency-scan.result }}"
        echo "Container Scan: ${{ needs.container-scan.result }}"
        echo "SAST Scan: ${{ needs.sast-scan.result }}"
        echo "Infrastructure Scan: ${{ needs.infrastructure-scan.result }}"
        echo "Security Headers: ${{ needs.security-headers.result }}"
        echo "Secrets Scan: ${{ needs.secrets-scan.result }}"
        echo "License Scan: ${{ needs.license-scan.result }}"
        echo ""
        echo "ðŸ“Š View detailed results in the Security tab"
        echo "ðŸ”— GitHub Security: https://github.com/${{ github.repository }}/security"





